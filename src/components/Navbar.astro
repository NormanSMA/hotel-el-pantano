---
const { pathname } = Astro.url;
const isHome = pathname === "/";
---

<header 
  id="navbar"
  class:list={[
    "fixed w-full top-0 z-50 transition-all duration-300",
    isHome ? "bg-transparent" : "bg-white shadow-sm"
  ]}
>
  <div class="container-site">
    <div class="flex justify-between items-center h-16 md:h-20">
      
      <!-- Logo -->
      <a href="/" class="flex items-center gap-3 group shrink-0">
        <img src="/logo.png" alt="Hotel El Pantano" class="h-14 sm:h-16 md:h-20 w-auto rounded-full" width="80" height="80" />
        <div class="flex flex-col leading-tight">
          <span id="brand-name" class:list={["font-serif text-lg md:text-xl font-bold tracking-wide transition-colors", isHome ? "text-white" : "text-gray-900"]}>
            El Pantano
          </span>
          <span id="brand-sub" class:list={["text-[0.6rem] uppercase tracking-[0.15em] transition-colors", isHome ? "text-white/70" : "text-gray-500"]}>
            Hotel &amp; Restaurante
          </span>
        </div>
      </a>

      <!-- Desktop Nav -->
      <nav class="hidden lg:flex items-center gap-1 ml-auto mr-4">
        <a href="/" class:list={[
          "nav-link px-3 py-2 rounded-md text-[1.05rem] font-medium transition-colors",
          pathname === "/" 
            ? (isHome ? "text-accent" : "text-primary font-semibold") 
            : (isHome ? "text-white/90 hover:text-white hover:bg-white/10" : "text-gray-600 hover:text-gray-900 hover:bg-gray-100")
        ]}>
          Inicio
        </a>

        <!-- Dropdown: Nuestros Servicios -->
        <div class="relative group">
          <button class:list={[
            "nav-link px-3 py-2 rounded-md text-[1.05rem] font-medium flex items-center gap-1 transition-colors",
            isHome ? "text-white/90 hover:text-white hover:bg-white/10" : "text-gray-600 hover:text-gray-900 hover:bg-gray-100"
          ]}>
            Nuestros Servicios
            <svg class="w-3.5 h-3.5 transition-transform group-hover:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
          </button>
          <div class="absolute left-0 top-full pt-2 w-52 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200">
            <div class="bg-white rounded-lg shadow-xl border border-gray-100 py-2 overflow-hidden">
              <a href="/menu" class="flex items-center gap-3 px-4 py-2.5 text-[0.95rem] text-gray-700 hover:bg-primary/5 hover:text-primary transition-colors">
                <svg class="w-4 h-4 text-primary/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
                Menú
              </a>
              <a href="/habitaciones" class="flex items-center gap-3 px-4 py-2.5 text-[0.95rem] text-gray-700 hover:bg-primary/5 hover:text-primary transition-colors">
                <svg class="w-4 h-4 text-primary/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>
                Habitaciones
              </a>
              <a href="/eventos" class="flex items-center gap-3 px-4 py-2.5 text-[0.95rem] text-gray-700 hover:bg-primary/5 hover:text-primary transition-colors">
                <svg class="w-4 h-4 text-primary/70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                Eventos
              </a>
            </div>
          </div>
        </div>

        <a href="/historia" class:list={[
          "nav-link px-3 py-2 rounded-md text-[1.05rem] font-medium transition-colors",
          pathname === "/historia" 
            ? (isHome ? "text-accent" : "text-primary font-semibold") 
            : (isHome ? "text-white/90 hover:text-white hover:bg-white/10" : "text-gray-600 hover:text-gray-900 hover:bg-gray-100")
        ]}>
          Nuestra Historia
        </a>
        <a href="/contacto" class:list={[
          "nav-link px-3 py-2 rounded-md text-[1.05rem] font-medium transition-colors",
          pathname === "/contacto" 
            ? (isHome ? "text-accent" : "text-primary font-semibold") 
            : (isHome ? "text-white/90 hover:text-white hover:bg-white/10" : "text-gray-600 hover:text-gray-900 hover:bg-gray-100")
        ]}>
          Contacto
        </a>
      </nav>

      <!-- Actions Group -->
      <div class="flex items-center gap-2 lg:gap-1">
        <!-- Theme Toggle (Visible Desktop & Mobile) -->
        <button id="theme-toggle" class:list={["p-2 rounded-md transition-all duration-300", isHome ? "text-white hover:bg-white/10" : "text-gray-600 hover:bg-gray-100"]} aria-label="Cambiar tema">
          <svg id="sun-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707M17.657 17.657l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"/></svg>
          <svg id="moon-icon" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/></svg>
        </button>

        <!-- Desktop Reservation Button (Moved after toggle) -->
        <a href="https://wa.me/50586538494" target="_blank" class="hidden lg:inline-flex bg-primary hover:bg-primary-dark text-white font-bold px-5 py-2 rounded-full text-sm transition-all hover:scale-105 shadow-md ml-2">
          Reservar
        </a>

        <!-- Mobile Toggle -->
        <button id="mobile-toggle" class:list={["lg:hidden p-2 rounded-md transition-colors", isHome ? "text-white hover:bg-white/10" : "text-gray-700 hover:bg-gray-100"]} aria-label="Menú">
          <svg id="hamburger-icon" class="h-7 w-7" stroke="currentColor" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
          </svg>
          <svg id="close-icon" class="h-7 w-7 hidden" stroke="currentColor" fill="none" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <!-- Mobile Menu -->
  <div id="mobile-menu" class:list={["lg:hidden hidden border-t bg-white dark:bg-slate-900 border-gray-100 dark:border-white/10 shadow-xl"]}>
    <div class="px-4 py-4 space-y-1">
      <a href="/" class:list={[
        "block px-4 py-3 rounded-lg text-base font-medium transition-colors",
        pathname === "/"
          ? "bg-primary/5 dark:bg-white/10 text-primary dark:text-accent"
          : "text-gray-700 dark:text-white/90 hover:bg-gray-50 dark:hover:bg-white/5"
      ]}>Inicio</a>
      
      <div>
        <button id="mobile-services-btn" class:list={[
          "w-full flex justify-between items-center px-4 py-3 rounded-lg text-base font-medium transition-colors",
          "text-gray-700 dark:text-white/90 hover:bg-gray-50 dark:hover:bg-white/5"
        ]}>
          Nuestros Servicios
          <svg id="mobile-services-arrow" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
        </button>
        <div id="mobile-services-panel" class:list={["hidden ml-4 mt-1 space-y-1 border-l-2 pl-3 border-primary/20 dark:border-accent/30"]}>
          <a href="/menu" class:list={["flex items-center gap-2 px-3 py-2 text-sm rounded transition-colors", "text-gray-600 dark:text-white/80 hover:text-primary dark:hover:text-white"]}>
            <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/></svg>
            Menú
          </a>
          <a href="/habitaciones" class:list={["flex items-center gap-2 px-3 py-2 text-sm rounded transition-colors", "text-gray-600 dark:text-white/80 hover:text-primary dark:hover:text-white"]}>
            <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0h4"/></svg>
            Habitaciones
          </a>
          <a href="/eventos" class:list={["flex items-center gap-2 px-3 py-2 text-sm rounded transition-colors", "text-gray-600 dark:text-white/80 hover:text-primary dark:hover:text-white"]}>
            <svg class="w-4 h-4 shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
            Eventos
          </a>
        </div>
      </div>
      
      <a href="/historia" class:list={[
        "block px-4 py-3 rounded-lg text-base font-medium transition-colors",
        pathname === "/historia"
          ? "bg-primary/5 dark:bg-white/10 text-primary dark:text-accent"
          : "text-gray-700 dark:text-white/90 hover:bg-gray-50 dark:hover:bg-white/5"
      ]}>Nuestra Historia</a>
      <a href="/contacto" class:list={[
        "block px-4 py-3 rounded-lg text-base font-medium transition-colors",
        pathname === "/contacto"
          ? "bg-primary/5 dark:bg-white/10 text-primary dark:text-accent"
          : "text-gray-700 dark:text-white/90 hover:bg-gray-50 dark:hover:bg-white/5"
      ]}>Contacto</a>
      
      <div class="pt-3 mt-3 border-t border-gray-100 dark:border-white/10">
        <a href="https://wa.me/50586538494" target="_blank" class="block text-center bg-primary hover:bg-primary-dark text-white font-bold px-4 py-3 rounded-lg transition-colors">
          Reservar por WhatsApp
        </a>
      </div>
    </div>
  </div>
</header>

<!-- Spacer for fixed navbar on non-home pages -->
{!isHome && <div class="h-16 md:h-20"></div>}

<script>
  const navbar = document.getElementById('navbar');
  const brandName = document.getElementById('brand-name');
  const brandSub = document.getElementById('brand-sub');
  const mobileToggle = document.getElementById('mobile-toggle');
  const mobileMenu = document.getElementById('mobile-menu'); // Added this line
  const isHomePage = document.body.dataset.page === 'home' || window.location.pathname === '/';

  function handleScroll() {
    if (!isHomePage) return;
    
    // Si el menú móvil está abierto, forzamos fondo blanco y no lo quitamos
    const isMobileMenuOpen = !mobileMenu?.classList.contains('hidden');
    
    if (window.scrollY > 60 || isMobileMenuOpen) {
      navbar?.classList.add('bg-white', 'shadow-sm');
      navbar?.classList.remove('bg-transparent');
      brandName?.classList.add('text-gray-900');
      brandName?.classList.remove('text-white');
      brandSub?.classList.add('text-gray-500');
      brandSub?.classList.remove('text-white/70');
      mobileToggle?.classList.add('text-gray-700');
      mobileToggle?.classList.remove('text-white');
      // Update nav links and theme toggle
      document.querySelectorAll('#navbar .nav-link, #theme-toggle').forEach(link => {
        if (!link.classList.contains('text-accent') && !link.classList.contains('text-primary')) {
          link.classList.remove('text-white', 'text-white/90');
          link.classList.add('text-gray-600', 'hover:bg-gray-100');
        }
      });
    } else {
      navbar?.classList.remove('bg-white', 'shadow-sm');
      navbar?.classList.add('bg-transparent');
      brandName?.classList.remove('text-gray-900');
      brandName?.classList.add('text-white');
      brandSub?.classList.remove('text-gray-500');
      brandSub?.classList.add('text-white/70');
      mobileToggle?.classList.remove('text-gray-700');
      mobileToggle?.classList.add('text-white');
      document.querySelectorAll('#navbar .nav-link, #theme-toggle').forEach(link => {
        if (!link.classList.contains('text-accent') && !link.classList.contains('text-primary')) {
          link.classList.remove('text-gray-600', 'hover:bg-gray-100');
          link.classList.add('text-white');
        }
      });
    }
  }

  if (isHomePage) {
    window.addEventListener('scroll', handleScroll);
    handleScroll();
  }

  // Mobile menu
  const toggle = document.getElementById('mobile-toggle');
  const hamburger = document.getElementById('hamburger-icon');
  const closeIcon = document.getElementById('close-icon');

  toggle?.addEventListener('click', () => {
    mobileMenu?.classList.toggle('hidden');
    hamburger?.classList.toggle('hidden');
    closeIcon?.classList.toggle('hidden');
    
    if (isHomePage) {
      handleScroll();
    }
  });

  // Theme Toggle Logic
  const themeToggle = document.getElementById('theme-toggle');
  const sunIcon = document.getElementById('sun-icon');
  const moonIcon = document.getElementById('moon-icon');

  const updateThemeIcons = () => {
    const isDark = document.documentElement.classList.contains('dark');
    if (isDark) {
      sunIcon?.classList.remove('hidden');
      moonIcon?.classList.add('hidden');
    } else {
      sunIcon?.classList.add('hidden');
      moonIcon?.classList.remove('hidden');
    }
  };

  themeToggle?.addEventListener('click', () => {
    document.documentElement.classList.toggle('dark');
    const isDark = document.documentElement.classList.contains('dark');
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
    updateThemeIcons();
  });

  // Initialize icons
  updateThemeIcons();

  // Mobile services dropdown
  const servicesBtn = document.getElementById('mobile-services-btn');
  const servicesPanel = document.getElementById('mobile-services-panel');
  const servicesArrow = document.getElementById('mobile-services-arrow');

  servicesBtn?.addEventListener('click', () => {
    servicesPanel?.classList.toggle('hidden');
    servicesArrow?.classList.toggle('rotate-180');
  });
</script>
